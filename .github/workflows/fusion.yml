name: Fusion Automation CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

permissions:
  contents: read
  actions: read

jobs:
  # ============================================
  # Stage 1: Codegen (Generate Bindings)
  # ============================================
  codegen:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Run Bindings Generation
      run: python -m tools.fusion.main --stage codegen --no-dashboard
    - name: Upload Codegen Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
        retention-days: 1
    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-codegen
        path: logs
    - name: Upload State
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: state-codegen
        path: build/run_state.json
        retention-days: 1

  # ============================================
  # Stage 1.1: Build Core (Rust + Python Bindings)
  # ============================================
  build-core:
    needs: codegen
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, ubuntu-24.04-arm, windows-11-arm]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview
    - name: Cache Rust build
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    - name: Download Codegen Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
    - name: Download State
      uses: actions/download-artifact@v4
      with:
        name: state-codegen
        path: build
      continue-on-error: true
    - name: Run Build Core
      run: python -m tools.fusion.main --stage build --target rust --no-codegen --no-dashboard
    - name: Upload Core Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: artifact-core-${{ matrix.os }}
        path: target
        retention-days: 1
    - name: Upload State
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: state-core-${{ matrix.os }}
        path: build/run_state.json
        retention-days: 1
    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-build-core-${{ matrix.os }}
        path: logs

  # ============================================
  # Stage 1.2: Build C++
  # ============================================
  build-cpp:
    needs: codegen
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, ubuntu-24.04-arm, windows-11-arm]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Download Codegen Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
    - name: Download State
      uses: actions/download-artifact@v4
      with:
        name: state-codegen
        path: build
      continue-on-error: true
    - name: Run Build C++
      # Using --clean to ensure fresh build if needed, but StateManager will skip if already PASS.
      run: python -m tools.fusion.main --stage build --target cpp --no-codegen --no-dashboard
    - name: Remove .gitignore (Force Upload)
      if: runner.os == 'Linux'
      run: rm .gitignore || true
    - name: Remove .gitignore (Windows)
      if: runner.os == 'Windows'
      run: del .gitignore
      continue-on-error: true
    - name: Upload C++ Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: artifact-cpp-${{ matrix.os }}
        path: ${{ runner.os == 'Linux' && 'build_linux' || 'build' }}
        retention-days: 1
    - name: Upload State
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: state-cpp-${{ matrix.os }}
        path: build/run_state.json
        retention-days: 1
    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-build-cpp-${{ matrix.os }}
        path: logs

  # ============================================
  # Stage 1.3: Build JS
  # ============================================
  build-js:
    needs: codegen
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, ubuntu-24.04-arm, windows-11-arm]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Download Codegen Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
    - name: Download State
      uses: actions/download-artifact@v4
      with:
        name: state-codegen
        path: build
      continue-on-error: true
    - name: Run Build JS
      run: python -m tools.fusion.main --stage build --target js --no-codegen --no-dashboard
    - name: Upload JS Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: artifact-js-${{ matrix.os }}
        path: |
          src/js
          examples/**/js*
          examples/integrated_apps/js_app
          examples/automotive_pubsub/js_adas
        retention-days: 1
    - name: Upload State
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: state-js-${{ matrix.os }}
        path: build/run_state.json
        retention-days: 1
    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-build-js-${{ matrix.os }}
        path: logs

  # ============================================
  # Stage 2: Test (depends on build)
  # ============================================


  unit-test-rust:
    needs: build-core
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, ubuntu-24.04-arm, windows-11-arm]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - name: Download Core Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-core-${{ matrix.os }}
        path: target
    - name: Download Codegen Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
    - name: Restore Permissions (Linux)
      if: runner.os == 'Linux'
      run: chmod -R +x build/* build_linux/* target/release/* target/debug/* || true
    - name: Install Dependencies
      run: pip install pytest pytest-cov

    - name: Download State
      uses: actions/download-artifact@v4
      with:
        name: state-core-${{ matrix.os }}
        path: build
      continue-on-error: true
    - name: Run Rust Unit Tests
      # Note: No --clean here, as it would wipe downloaded artifacts
      run: python -m tools.fusion.main --stage test --target rust --pass-filter host --no-dashboard --skip-demos
    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-unit-rust-${{ matrix.os }}
        path: logs

  unit-test-python:
    needs: [build-core, build-cpp, build-js]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, ubuntu-24.04-arm, windows-11-arm]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Download Core Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-core-${{ matrix.os }}
        path: target
    - name: Download Codegen Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
    - name: Download C++ Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-cpp-${{ matrix.os }}
        path: build
    - name: Download JS Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-js-${{ matrix.os }}
        path: .
    - name: Restore Permissions (Linux)
      if: runner.os == 'Linux'
      run: chmod -R +x build/* build_linux/* target/release/* target/debug/* || true

    - name: Install Dependencies
      run: |
        pip install pytest pytest-cov
        npm install
      working-directory: src/js
    - name: Install JS App Dependencies
      run: |
        npm install
      working-directory: examples/integrated_apps/js_app
    - name: Download State
      uses: actions/download-artifact@v4
      with:
        pattern: state-*
        path: build
        merge-multiple: true
      continue-on-error: true
    - name: Run Python Unit Tests
      env:
        PYTHONPATH: src/python:build:build/generated/integrated_apps/python:build/generated/automotive_pubsub/python:third_party/someipy/src
        FUSION_LOG_DIR: logs/unit_python
      # Note: No --clean here
      run: |
        # Ensure we can bind to ports on Linux
        python -m tools.fusion.main --stage test --target python --pass-filter host --base-port auto --no-dashboard --skip-demos
    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-unit-python-${{ matrix.os }}
        path: logs

  unit-test-cpp:
    needs: [codegen, build-cpp]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, ubuntu-24.04-arm, windows-11-arm]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - name: Download Codegen Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
    - name: Download C++ Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-cpp-${{ matrix.os }}
        path: build
    - name: Restore Permissions (Linux)
      if: runner.os == 'Linux'
      run: chmod -R +x build/* build_linux/* target/release/* target/debug/* || true
    - name: Install Dependencies
      run: pip install pytest pytest-cov

    - name: Run C++ Unit Tests
      # Note: No --clean here
      run: python -m tools.fusion.main --stage test --target cpp --no-dashboard --skip-demos
    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-unit-cpp-${{ matrix.os }}
        path: logs

  unit-test-js:
    needs: [codegen, build-js]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, ubuntu-24.04-arm, windows-11-arm]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Download Codegen Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
    - name: Download JS Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-js-${{ matrix.os }}
        path: .
    - name: Install JS Dependencies
      run: npm install
      working-directory: src/js
    - name: Install Python Dependencies
      run: pip install pytest pytest-cov
    - name: Run JS Unit Tests with Coverage
      run: python -m tools.fusion.main --stage coverage --target js --no-dashboard --skip-demos
    - name: Upload Logs and Coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-unit-js-${{ matrix.os }}
        path: |
          logs
          logs/latest/coverage/js

  demo-simple:
    needs: [build-core, build-cpp, build-js]

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, ubuntu-24.04-arm, windows-11-arm]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Download Core Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-core-${{ matrix.os }}
        path: target
    - name: Download C++ Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-cpp-${{ matrix.os }}
        path: ${{ runner.os == 'Linux' && 'build_linux' || 'build' }}
    - name: Download JS Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-js-${{ matrix.os }}
        path: .
    - name: Restore Permissions (Linux)
      if: runner.os == 'Linux'
      run: chmod -R +x build/* build_linux/* target/release/* target/debug/* || true
    - name: Install Dependencies
      run: pip install pytest pytest-cov

    - name: Run Simple Demo
      run: python -m tools.fusion.main --stage demos --demo simple --base-port 0 --no-dashboard
    - name: Upload Logs and Configs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-demo-simple-${{ matrix.os }}
        path: |
          logs
          build/generated

  demo-integrated:
    needs: [codegen, build-core, build-cpp, build-js]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, ubuntu-24.04-arm, windows-11-arm]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Download Codegen Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
    - name: Download Core Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-core-${{ matrix.os }}
        path: target
    - name: Download C++ Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-cpp-${{ matrix.os }}
        path: ${{ runner.os == 'Linux' && 'build_linux' || 'build' }}
    - name: Download JS Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-js-${{ matrix.os }}
        path: .
    - name: Install JS Dependencies
      run: |
        npm install
        npm run build || true
      working-directory: src/js
    - name: Install JS App Dependencies
      run: |
        npm install
      working-directory: examples/integrated_apps/js_app
    - name: Restore Permissions (Linux)
      if: runner.os == 'Linux'
      run: chmod -R +x build/* build_linux/* target/release/* target/debug/* || true
    - name: Install Dependencies
      run: pip install pytest pytest-cov

    - name: Run Integrated Demo
      run: python -m tools.fusion.main --stage demos --demo integrated --base-port 100 --no-dashboard
    - name: Upload Logs and Configs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-demo-integrated-${{ matrix.os }}
        path: |
          logs
          build/generated

  demo-pubsub:
    needs: [codegen, build-core, build-cpp, build-js]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, ubuntu-24.04-arm, windows-11-arm]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Download Codegen Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
    - name: Download Core Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-core-${{ matrix.os }}
        path: target
    - name: Download C++ Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-cpp-${{ matrix.os }}
        path: ${{ runner.os == 'Linux' && 'build_linux' || 'build' }}
    - name: Download JS Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-js-${{ matrix.os }}
        path: .
    - name: Download Codegen for JS Demo
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: examples/automotive_pubsub/js_adas/src/generated
    - name: Install JS Dependencies (Runtime)
      run: |
        npm install
        npm run build
      working-directory: src/js
    - name: Install JS Dependencies (ADAS JS)
      run: |
        npm install
        npm run build || true
      working-directory: examples/automotive_pubsub/js_adas/
    - name: Restore Permissions (Linux)
      if: runner.os == 'Linux'
      run: chmod -R +x build/* build_linux/* target/release/* target/debug/* || true
    - name: Install Dependencies
      run: pip install pytest pytest-cov

    - name: Run PubSub Demo
      run: python -m tools.fusion.main --stage demos --demo pubsub --base-port 200 --no-dashboard
    - name: Upload Logs and Configs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-demo-pubsub-${{ matrix.os }}
        path: |
          logs
          build/generated

  demo-someipy:
    needs: [codegen, build-core, build-cpp, build-js]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, ubuntu-24.04-arm, windows-11-arm]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Download Codegen Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
    - name: Download Core Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-core-${{ matrix.os }}
        path: target
    - name: Download C++ Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-cpp-${{ matrix.os }}
        path: ${{ runner.os == 'Linux' && 'build_linux' || 'build' }}
    - name: Download JS Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-js-${{ matrix.os }}
        path: .
    - name: Install JS Dependencies (Runtime)
      run: |
        npm install
        npm run build
      working-directory: src/js
    - name: Install JS Dependencies (Demo Client)
      run: |
        npm install
        npm run build
      working-directory: examples/someipy_demo/js_client/
    - name: Restore Permissions (Linux)
      if: runner.os == 'Linux'
      run: chmod -R +x build/* build_linux/* target/release/* target/debug/* || true
    - name: Install Dependencies
      run: pip install pytest pytest-cov
    - name: Run someipy Demo
      env:
        PYTHONPATH: src/python:build:build/generated/integrated_apps/python:build/generated/automotive_pubsub/python:third_party/someipy/src
      run: python -m tools.fusion.main --stage demos --demo someipy --no-dashboard
    - name: Upload Logs and Configs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-demo-someipy-${{ matrix.os }}
        path: |
          logs
          build/generated

  demo-tp:
    needs: [codegen, build-core]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, ubuntu-24.04-arm, windows-11-arm]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Download Codegen Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
    - name: Download Core Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-core-${{ matrix.os }}
        path: target
    - name: Restore Permissions (Linux)
      if: runner.os == 'Linux'
      run: chmod -R +x build/* build_linux/* target/release/* target/debug/* || true
    - name: Install Dependencies
      run: pip install pytest pytest-cov
    - name: Run Large Payload (TP) Demo
      run: python -m tools.fusion.main --stage demos --demo tp --no-dashboard
    - name: Upload Logs and Configs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-demo-tp-${{ matrix.os }}
        path: |
          logs
          build/generated

  # ============================================
  # Stage 2.5: Virtual Network Tests (Linux-only)
  # ============================================
  vnet-test:
    needs: [codegen, build-core, build-cpp, build-js]
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest
    - name: Install JS Dependencies
      run: |
        npm install
      working-directory: src/js
    - name: Install JS App Dependencies
      run: |
        npm install
      working-directory: examples/integrated_apps/js_app
    - name: Download Codegen Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
    - name: Download Core Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-core-${{ matrix.os }}
        path: target
    - name: Download C++ Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-cpp-${{ matrix.os }}
        path: build
    - name: Download JS Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-js-${{ matrix.os }}
        path: .
    - name: Download State
      uses: actions/download-artifact@v4
      with:
        pattern: state-*
        path: build
        merge-multiple: true
      continue-on-error: true
    - name: Restore Permissions (Linux)
      run: chmod -R +x build/* build_linux/* target/release/* target/debug/* || true
    - name: Setup Virtual Network
      run: sudo bash tools/fusion/scripts/setup_vnet.sh
    - name: Run VNET Tests and Use-Cases
      # We use --pass-filter vnet to avoid re-running host tests
      env:
        PYTHONPATH: src/python:build:build/generated/integrated_apps/python:build/generated/automotive_pubsub/python:third_party/someipy/src
      run: |
        sudo -E $(which python) -m tools.fusion.main --stage test --target python --pass-filter vnet --base-port auto --no-dashboard
        sudo -E $(which python) -m tools.fusion.main --stage demos --demo usecases --pass-filter vnet --base-port auto --no-dashboard
    - name: Teardown Virtual Network
      if: always()
      run: sudo bash tools/fusion/scripts/teardown_vnet.sh
    - name: Upload Logs and Configs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-vnet-test-${{ matrix.os }}
        path: |
          logs
          build/generated

  coverage:
    # Coverage typically easiest on Linux (lcov, llvm-cov)
    needs: [codegen, build-core, build-cpp]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Download Codegen Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-codegen
        path: build/generated
    - name: Download Core Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-core-ubuntu-latest
        path: target
    - name: Download C++ Artifacts
      uses: actions/download-artifact@v4
      with:
        name: artifact-cpp-ubuntu-latest
        path: build_linux
    - name: Restore Permissions (Linux)
      run: chmod -R +x build/* build_linux/* target/release/* target/debug/* || true
    - name: Install Coverage Tools
      run: |
        sudo apt-get update && sudo apt-get install -y lcov
        pip install pytest pytest-cov
        curl -LsSf https://github.com/taiki-e/cargo-llvm-cov/releases/latest/download/cargo-llvm-cov-x86_64-unknown-linux-gnu.tar.gz | tar xzf - -C ~/.cargo/bin || true
    - name: Rebuild C++ with Coverage
      # Rebuild is clean by nature if we pass --clean, or just force clean.
      # Coverage specific flags.
      run: |
        python -m tools.fusion.main --stage build --target cpp --with-coverage --no-codegen --no-dashboard --clean
    - name: Restore Permissions
      run: chmod -R +x build/* build_linux/* target/release/* target/debug/* || true

    - name: Run Coverage
      run: python -m tools.fusion.main --stage coverage --base-port 400 --no-dashboard
    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-coverage
        path: logs

  # ============================================
  # Stage 3: Generate Documentation (depends on build)
  # ============================================
  docs:
    needs: [codegen, build-core, build-cpp, build-js, unit-test-rust, unit-test-cpp, unit-test-python, unit-test-js, demo-simple, demo-integrated, demo-pubsub, demo-someipy, vnet-test, coverage]

    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Download All Logs
      uses: actions/download-artifact@v4
      with:
        pattern: logs-*
        path: .
        merge-multiple: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: pip install plantuml markdown

    - name: Generate Diagrams
      run: python -m tools.fusion.main --stage diagrams --no-dashboard

    - name: Prepare GitHub Pages content
      run: |
        mkdir -p _site/images _site/diagrams _site/reports
        
        # Copy documentation markdown files
        cp docs/*.md _site/
        cp README.md _site/
        cp examples/README.md _site/examples.md
        cp examples/automotive_pubsub/README.md _site/automotive_pubsub.md
        
        # Copy generated images
        cp -r docs/images/* _site/images/ 2>/dev/null || true
        
        # Copy diagram sources
        cp -r docs/diagrams/*.puml _site/diagrams/ 2>/dev/null || true
        
        # Copy test reports (find latest log directory)
        if [ -d "logs" ]; then
          cp -r logs/* _site/reports/ 2>/dev/null || true
        fi

    - name: Convert Markdown to HTML
      run: |
        pip install markdown
        
        # Create conversion script
        cat > convert_md.py << 'PYEOF'
        import os
        import re
        import markdown
        from pathlib import Path
        
        def convert_links(html):
            """Convert .md links to .html links"""
            # href="something.md" -> href="something.html"
            html = re.sub(r'href="([^"]+)\.md(#[^"]*)?"\s*>', r'href="\1.html\2">', html)
            # href="../docs/something.md" -> href="something.html" (flattened structure)
            html = re.sub(r'href="(?:\.\./)?docs/([^"]+)\.md(#[^"]*)?"\s*>', r'href="\1.html\2">', html)
            # href="examples/README.md" -> href="examples.html"
            html = re.sub(r'href="examples/README.md(#[^"]*)?"\s*>', r'href="examples.html\1">', html)
            # href="automotive_pubsub/README.md" -> href="automotive_pubsub.html"
            html = re.sub(r'href="automotive_pubsub/README.md(#[^"]*)?"\s*>', r'href="automotive_pubsub.html\1">', html)
            return html
        
        def convert_image_paths(html):
            """Fix image paths for flat directory structure"""
            # ../../docs/images/foo.png -> images/foo.png (for deep examples)
            html = html.replace('../../docs/images/', 'images/')
            html = html.replace('../../docs/diagrams/', 'diagrams/')
            # ../docs/images/foo.png -> images/foo.png
            html = html.replace('../docs/images/', 'images/')
            html = html.replace('../docs/diagrams/', 'diagrams/')
            # images/foo.png stays as images/foo.png
            return html
        
        # Process all markdown files
        for md_file in Path('_site').glob('*.md'):
            name = md_file.stem
            print(f"Converting {md_file.name} to {name}.html")
            
            content = md_file.read_text(encoding='utf-8')
            
            # Convert markdown to HTML
            html_body = markdown.markdown(
                content, 
                extensions=['tables', 'fenced_code', 'toc', 'attr_list']
            )
            
            # Fix links and image paths
            html_body = convert_links(html_body)
            html_body = convert_image_paths(html_body)
            
            # Create full HTML page
            html = f'''<!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>{name} - Fusion Hawking</title>
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown.min.css">
          <style>
            .markdown-body {{ max-width: 980px; margin: 0 auto; padding: 20px; }}
            img {{ max-width: 100%; }}
            pre {{ background: #1e1e1e; padding: 16px; border-radius: 6px; overflow-x: auto; }}
            code {{ background: #1e1e1e; padding: 2px 6px; border-radius: 3px; }}
            details {{ margin: 10px 0; padding: 10px; background: #161b22; border-radius: 6px; }}
            summary {{ cursor: pointer; font-weight: bold; }}
            nav {{ background: #21262d; padding: 10px 20px; margin: -20px -20px 20px -20px; border-radius: 6px 6px 0 0; }}
            nav a {{ color: #58a6ff; margin-right: 15px; text-decoration: none; }}
            nav a:hover {{ text-decoration: underline; }}
          </style>
        </head>
        <body class="markdown-body">
          <nav>
            <a href="index.html">Home</a>
            <a href="architecture.html">Architecture</a>
            <a href="user_guide.html">User Guide</a>
            <a href="IDL.html">IDL</a>
            <a href="design_and_requirements.html">Design</a>
            <a href="examples.html">Examples</a>
            <a href="test_matrix.html">Tests</a>
            <a href="reports/index.html">Reports</a>
          </nav>
        {html_body}
        </body>
        </html>'''
            
            # Write HTML file
            html_file = md_file.with_suffix('.html')
            html_file.write_text(html, encoding='utf-8')
            
            # Remove original .md file from _site
            md_file.unlink()
        
        print("Conversion complete!")
        PYEOF
        
        python convert_md.py

    - name: Create index page
      run: |
        cat > _site/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Fusion Hawking - SOME/IP Stack</title>
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown.min.css">
          <style>
            .markdown-body { max-width: 980px; margin: 0 auto; padding: 20px; }
            .card { background: #21262d; padding: 20px; border-radius: 8px; margin: 10px 0; }
            .card h3 { margin-top: 0; }
            .card a { color: #58a6ff; }
            nav { background: #21262d; padding: 10px 20px; margin: -20px -20px 20px -20px; border-radius: 6px 6px 0 0; }
            nav a { color: #58a6ff; margin-right: 15px; text-decoration: none; }
          </style>
        </head>
        <body class="markdown-body">
          <nav>
            <a href="index.html">Home</a>
            <a href="architecture.html">Architecture</a>
            <a href="user_guide.html">User Guide</a>
            <a href="IDL.html">IDL</a>
            <a href="design_and_requirements.html">Design</a>
            <a href="examples.html">Examples</a>
            <a href="test_matrix.html">Tests</a>
            <a href="reports/index.html">Reports</a>
          </nav>
          
          <h1>üöÄ Fusion Hawking</h1>
          <p>A lightweight, dependency-free SOME/IP stack in Rust with Python and C++ bindings.</p>
          
          <div class="card">
            <h3>üìê <a href="architecture.html">Architecture</a></h3>
            <p>Visual diagrams of system components, deployment, data flow, and protocols.</p>
          </div>
          
          <div class="card">
            <h3>üìñ <a href="user_guide.html">User Guide</a></h3>
            <p>Quick start, configuration, and API reference for Rust, Python, and C++.</p>
          </div>
          
          <div class="card">
            <h3>üíª <a href="examples.html">Examples</a></h3>
            <p>Annotated code samples for SD, RPC, and Pub-Sub patterns.</p>
          </div>
          
          <div class="card">
            <h3>üîß <a href="IDL.html">IDL Reference</a></h3>
            <p>Interface Definition Language for service definitions and code generation.</p>
          </div>
          
          <div class="card">
            <h3>üìã <a href="design_and_requirements.html">Design Document</a></h3>
            <p>Design decisions, configuration schema, and technical requirements.</p>
          </div>
          
          <div class="card">
            <h3>‚úÖ <a href="test_matrix.html">Test Matrix</a></h3>
            <p>Test coverage, cross-language interoperability, and verification status.</p>
          </div>
          
          <div class="card">
            <h3>üìä <a href="reports/index.html">Build Reports</a></h3>
            <p>Latest CI build results, test reports, and coverage data.</p>
          </div>
        </body>
        </html>
        EOF

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

  # ============================================
  # Stage 4: Deploy to GitHub Pages (depends on docs)
  # ============================================
  deploy:
    runs-on: ubuntu-latest
    needs: docs
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
